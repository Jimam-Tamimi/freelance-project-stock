{% extends "base.html" %}

{% load crispy_forms_tags %}

{% block headers %}
    <!-- XDSoft DateTimePicker -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css" /> -->

  <style>
  .bootstrap-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    list-style: none;
    font-size: 14px;
    text-align: left;
    background-color: #ffffff;
    border: 1px solid #cccccc;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
    background-clip: padding-box;
}

.bootstrap-autocomplete > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: normal;
  line-height: 1.42857143;
  color: #333333;
  white-space: nowrap;
}

.li-state-hover,
.li-state-active,
.li-state-focus {
  text-decoration: none;
  color: #262626;
  background-color: #f5f5f5;
  cursor: pointer;
}

.li-helper-hidden-accessible {
  border: 0;
  clip: rect(0 0 0 0);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#container {
	max-height: 800px;
	min-height: 75vh;
}


  </style>

<link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/stocktools/gui.css">
<link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/annotations/popup.css">
  
{% endblock %}


{% block portfolio-name %}
<div class="row m-3">
  <div class="col">
    <h2 class="az-content-title mg-b-5 mg-b-lg-8">{{ watchlist.watchlist_name }}</h2> 
    <h2 id="watchlist_id" class="az-content-title mg-b-5 mg-b-lg-8">{{ watchlist.id }}</h2> 
  </div>
  <div class="col">
    <button class="nav-link" data-toggle="modal" data-target="#modalAddWatchlist" href>Add to List</a>
  </div>
</div>
  
{% endblock %}





{% block content %}


  <div class="modal" id="modalAddWatchlist">
    <div class="modal-dialog"  role="document">
      <div class="modal-content" id="modalForm">
        <div class="modal-header">
          <h6 class="modal-title">Add Stock</h6>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">Ã—</span>
          </button>
        </div>
          <form id="myAddWatchlistForm">
            <div class="modal-body">
              {% crispy form %}
            </div>
          </form>
      </div><!-- modal-content -->
    </div><!-- modal-dialog -->
  </div><!-- modal -->    


  <br/>

  <div class="row m-3">
    <div class="col">
      <div class="container-fluid">
        <div class="table-responsive">
          <div class="dataTables_wrapper no-footer" style="width:90%;">
            <table id="watchlistID" class="table table-striped table-hover nowrap dt-responsive"  style="width:100%;" >
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Name</th>
                  <th>Current Price</th>
                  <!-- <th>Last Price Update Date & Time</th> -->
                  <th>Day Change</th>
                  <th>Day Change %</th>
                  <th>Day Lo</th>
                  <th>Day Hi</th>
                  <th>52 Week Lo</th>
                  <th>52 Week Hi</th>
                  <th>Volume</th>
                  <th>Volume Average 10 days</th>
                  <th>Volume Average 3M</th>
                  <th>MktCap</th>
                  <th>EPS</th>
                  <th>P/E</th>
                  <th>P/B</th>
                  <th>EV/EBITDA</th>
                  <th>Dividend Yield</th>
                  <th>D/E</th>
                  <th>ROE</th>
                  <th>ROA</th>
                  <th>Revenues</th>
                  <th>EBITDA</th>
                  <!-- <th>Net Profit</th> -->
                  <th>Sector</th>
                  <th>Industry</th>
                  <th>Website</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
      </div>
      
    </div>
  </div> 
  


  <div class="row m-3">
    <div class="col">
      <div class="container-fluid">        
        <div id="container" class="chart"></div>
      </div>
    </div>
  </div>

  


{% endblock %}  


{% block javascript %}
  <script src="//cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.rawgit.com/xcash/bootstrap-autocomplete/3de7ad37/dist/latest/bootstrap-autocomplete.js"></script>


  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/data.js"></script>
  
  <script src="https://code.highcharts.com/stock/indicators/indicators-all.js"></script>
  <script src="https://code.highcharts.com/stock/modules/drag-panes.js"></script>
  
  <script src="https://code.highcharts.com/modules/annotations-advanced.js"></script>
  <script src="https://code.highcharts.com/modules/price-indicator.js"></script>
  <script src="https://code.highcharts.com/modules/full-screen.js"></script>
  
  <script src="https://code.highcharts.com/modules/stock-tools.js"></script>

  <script> //autoComplete
    // var symbol = document.getElementById('id_symbol').textContent
    $('#id_symbol').autoComplete({
        resolverSettings: {
            url: window.location.origin + '/api/suggestions/'
        }
                
    });
 
    
    $('#id_symbol').on('autocomplete.select', function (e) {
          // var symbol = $('#id_symbol').val()
          var symbol = document.getElementById('id_symbol').value

					console.log(symbol);
          
				});
    


  </script>


  <script> //tables and charts

    $(document).ready(function() {

      var watchlist_id = document.getElementById('watchlist_id').textContent

      var collapsedGroups = {};
      var table = $('#watchlistID').DataTable({
        bAutoWidth: false,
        responsive: true,
        colReorder: true,
        stateSave:  true,
        paging: true,
        autoWidth: true,
        select: {
            style: 'single'
        },
        ajax: window.location.origin + '/api/watchlists/' + watchlist_id + '/stocks/?format=datatables',
        order: [[ 0, "desc" ]],
        columnDefs: [
          {"className": "dt-center", "targets": "_all"}
        ],
        columns: [
          { "data": "symbol" },
          { "data": "longName" },
          { "data": "regularMarketPrice" },
          // { "data": "regularMarketTime" },
          { "data": "regularMarketChange" },
          { "data": "regularMarketChangePercent" },
          { "data": "regularMarketDayLow" },
          { "data": "regularMarketDayHigh" },
          { "data": "fiftyTwoWeekLow" },
          { "data": "fiftyTwoWeekHigh" },
          { "data": "regularMarketVolume" },
          { "data": "averageDailyVolume10Day" },
          { "data": "averageDailyVolume3Month" },
          { "data": "marketCap" },
          { "data": "epsTrailingTwelveMonths" },
          { "data": "trailingPE" },
          { "data": "priceToBook" },
          { "data": "enterpriseToEbitda" },
          { "data": "trailingAnnualDividendYield" },
          { "data": "debtToEquity" },
          { "data": "returnOnEquity" },
          { "data": "returnOnAssets" },
          { "data": "totalRevenue" },
          { "data": "ebitda" },
          // { "data": "netIncome" },
          { "data": "sector" },
          { "data": "industry" },
          { "data": "website" }
        ],
        
        
      });

      var chart_symbol = 'SYMBOL'

      $('#example tbody tr.group-start').each(function() {
                var name = $(this).data('name');
                collapsedGroups[name] = !collapsedGroups[name];
      });
      table.draw(false);

      $('#example tbody').on('click', 'tr.group-start', function () {
                var name = $(this).data('name');
                chart_symbol = name
                collapsedGroups[name] = !collapsedGroups[name];
                table.draw(false);
      });  

      table
        .on( 'select', function ( e, dt, type, indexes ) {
            var rowData = table.rows( indexes ).data().toArray();
            var name = rowData[0]['symbol'];
            chart_symbol = name
            console.log(chart_symbol)
            // events.prepend( '<div><b>'+type+' selection</b> - '+JSON.stringify( rowData )+'</div>' );

            if (chart_symbol.includes('.')) {
              chart_new_symbol = chart_symbol.replace('.', 'DOT')
            }
            else{
              chart_new_symbol = chart_symbol
            }

            Highcharts.getJSON(window.location.origin + '/api/charts/' + chart_new_symbol + 'delimeter10y/', function (data) {

                    // console.log('Highcharts', data)

                    // split the data set into ohlc and volume
                    var ohlc = [],
                    volume = [],
                    dataLength = data.length,
                    i = 0;

                    for (i; i < dataLength; i += 1) {
                    ohlc.push([
                      data[i][0], // the date
                      data[i][1], // open
                      data[i][2], // high
                      data[i][3], // low
                      data[i][4] // close
                    ]);

                    volume.push([
                      data[i][0], // the date
                      data[i][5] // the volume
                    ]);
                    }

                    Highcharts.stockChart('container', {
                    yAxis: [{
                      labels: {
                        align: 'left'
                      },
                      height: '80%',
                      resize: {
                        enabled: true
                      }
                    }, {
                      labels: {
                        align: 'left'
                      },
                      top: '80%',
                      height: '20%',
                      offset: 0
                    }],
                    tooltip: {
                      shape: 'square',
                      headerShape: 'callout',
                      borderWidth: 0,
                      shadow: false,
                      positioner: function (width, height, point) {
                        var chart = this.chart,
                          position;

                        if (point.isHeader) {
                          position = {
                            x: Math.max(
                              // Left side limit
                              chart.plotLeft,
                              Math.min(
                                point.plotX + chart.plotLeft - width / 2,
                                // Right side limit
                                chart.chartWidth - width - chart.marginRight
                              )
                            ),
                            y: point.plotY
                          };
                        } else {
                          position = {
                            x: point.series.chart.plotLeft,
                            y: point.series.yAxis.top - chart.plotTop
                          };
                        }

                        return position;
                      }
                    },
                    title: {
                        text: chart_symbol + ' Stock Price'
                    },
                    series: [{
                      type: 'ohlc',
                      id: 'ohlc',
                      name: chart_symbol + ' Stock Price',
                      data: ohlc
                    }, {
                      type: 'column',
                      id: 'volume',
                      name: chart_symbol + ' Volume',
                      data: volume,
                      yAxis: 1
                    }],
                    responsive: {
                      rules: [{
                        condition: {
                          maxWidth: 800
                        },
                        chartOptions: {
                          rangeSelector: {
                            inputEnabled: false
                          }
                        }
                      }]
                    }
                    });
                    });
        } )
        .on( 'deselect', function ( e, dt, type, indexes ) {
            var rowData = table.rows( indexes ).data().toArray();
            events.prepend( '<div><b>'+type+' <i>de</i>selection</b> - '+JSON.stringify( rowData )+'</div>' );
        } );


        const tr = $("<tr><td>CASH</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
        table.row.add(tr[0]).draw();


    });



  </script>



  <script> //watchlist

    updateStocks()

    //Making a GET request with fetch
    function updateStocks() {

      console.log('Updating Stocks in Watchlist ...')

      var watchlist_id = document.getElementById('watchlist_id').textContent
      var URL = window.location.origin + '/api/watchlists/' + watchlist_id + '/stocks/'

      fetch(URL, {
        headers:{
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest', //Necessary to work with request.is_ajax()
        },
      })
      .then(response => {
      
        return response.json() //Convert response to JSON      
      })
      .then(data => {
        //Perform actions with the response data from the view      
        console.log('GET Stocks List - : ', data.results)
        $('#watchlistID').DataTable().draw()
        

        var list = data.results
        for (var i in list) {
          console.log('GET Watchlist Data: ', list[i])
          
        }
        
      })
    }

  //Making a POST/Update request with fetch
  const stocksForm = document.getElementById('myAddWatchlistForm')
    
  stocksForm.addEventListener('submit', function(e){
    e.preventDefault();

    console.log('Submitting myAddWatchlistForm - POST')

    var watchlist_id = document.getElementById('watchlist_id').textContent
    var URL = window.location.origin + '/api/watchlists/' + watchlist_id + '/stocks/'

    const dataS = new FormData(this)
    const searchParamS = new URLSearchParams()
    
    for (const pair of dataS) {
      searchParamS.append(pair[0], pair[1])
      
      console.log(pair[0], pair[1])
    }

    fetch(URL, {
      method: 'POST',
      headers:{
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest', //Necessary to work with request.is_ajax()
          'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({
        'symbol': searchParamS.get('symbol'),        
        'watchlist': watchlist_id,
      }) //JavaScript object of data to POST
    })

    .then(response => {
      updateStocks()
      document.getElementById('myAddWatchlistForm').reset()
      $('#modalAddWatchlist').modal('toggle');
    })
    .then(data => {
      console.log('POSTED Watchlist DATA', data)      
      $('#watchlistID').DataTable().draw()
      //Perform actions with the response data from the view
    })
    .catch(error => {
      console.log('ERROR', error)
    })
    
  });



  </script>





{% endblock %}
