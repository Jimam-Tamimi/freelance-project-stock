{% extends "base.html" %}

{% load crispy_forms_tags %}

{% block headers %}
    <!-- XDSoft DateTimePicker -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.min.css" /> -->

  <style>
    td.details-control {
    background: url('../resources/details_open.png') no-repeat center center;
    cursor: pointer;
}
tr.shown td.details-control {
    background: url('../resources/details_close.png') no-repeat center center;
}


  .bootstrap-autocomplete {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    display: none;
    float: left;
    min-width: 160px;
    padding: 5px 0;
    margin: 2px 0 0;
    list-style: none;
    font-size: 14px;
    text-align: left;
    background-color: #ffffff;
    border: 1px solid #cccccc;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-radius: 4px;
    -webkit-box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.175);
    background-clip: padding-box;
}

.bootstrap-autocomplete > li > a {
  display: block;
  padding: 3px 20px;
  clear: both;
  font-weight: normal;
  line-height: 1.42857143;
  color: #333333;
  white-space: nowrap;
}

.li-state-hover,
.li-state-active,
.li-state-focus {
  text-decoration: none;
  color: #262626;
  background-color: #f5f5f5;
  cursor: pointer;
}

.li-helper-hidden-accessible {
  border: 0;
  clip: rect(0 0 0 0);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#container {
	max-height: 800px;
	min-height: 75vh;
}







    .highcharts-figure, .highcharts-data-table table {
        min-width: 320px; 
        max-width: 660px;
        margin: 1em auto;
    }
 
    .highcharts-data-table table {
      font-family: Verdana, sans-serif;
      border-collapse: collapse;
      border: 1px solid #EBEBEB;
      margin: 10px auto;
      text-align: center;
      width: 100%;
      max-width: 500px;
    }
    .highcharts-data-table caption {
        padding: 1em 0;
        font-size: 1.2em;
        color: #555;
    }
    .highcharts-data-table th {
      font-weight: 600;
        padding: 0.5em;
    }
    .highcharts-data-table td, .highcharts-data-table th, .highcharts-data-table caption {
        padding: 0.5em;
    }
    .highcharts-data-table thead tr, .highcharts-data-table tr:nth-child(even) {
        background: #f8f8f8;
    }
    .highcharts-data-table tr:hover {
        background: #f1f7ff;
    } 


  </style>

<link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/stocktools/gui.css">
<link rel="stylesheet" type="text/css" href="https://code.highcharts.com/css/annotations/popup.css">


  
{% endblock %}

{% block portfoliodetail %}
<h2 class="az-content-title tx-24 mg-b-5 mg-b-lg-8">{{ portfolio.name }}</h2> 
<p class="mg-b-0"><h6 id="portfolio_id">{{ portfolio.id }}</h6></p>

{% endblock %}
            

{% block content %}

<div class="row row-sm">
  
  <div class="col-sm-6 col-lg-12 col-xl-3 mg-t-20 mg-xl-t-0">
    <div class="d-lg-flex d-xl-block">
      <div class="card wd-lg-50p wd-xl-auto">
        <div class="card-header">
          <h6 class="card-title tx-14 mg-b-0">Cash</h6>
        </div><!-- card-header -->
        <div class="card-body">
          <h3 class="tx-bold tx-inverse lh--5 mg-b-15">{{ portfolio.cash }} <span class="tx-base tx-normal tx-gray-600">INR. </span></h3>
        </div><!-- card-body -->
      </div><!-- card -->
       
    </div>
  </div><!-- col-3 -->
  <div class="col-sm-6 col-lg-12 col-xl-3 mg-t-20 mg-xl-t-0">
    <div class="d-lg-flex d-xl-block">
      <div class="card wd-lg-50p wd-xl-auto">
        <div class="card-header">
          <h6 class="card-title tx-14 mg-b-0">Overall return</h6>
        </div><!-- card-header -->
        <div class="card-body">
          <h3 class="tx-bold tx-inverse lh--5 mg-b-15">+$0.00 <span class="tx-base tx-normal tx-gray-600">/ Goal: 8m:0s</span></h3>
        </div><!-- card-body -->
      </div><!-- card -->
       
    </div>
  </div><!-- col-3 -->
  <div class="col-sm-6 col-lg-12 col-xl-3 mg-t-20 mg-xl-t-0">
    <div class="d-lg-flex d-xl-block">
      <div class="card wd-lg-50p wd-xl-auto">
        <div class="card-header">
          <h6 class="card-title tx-14 mg-b-0">Market value</h6>
        </div><!-- card-header -->
        <div class="card-body">
          <h3 class="tx-bold tx-inverse lh--5 mg-b-15">$15,126,369.20 <span class="tx-base tx-normal tx-gray-600">/ Goal: 8m:0s</span></h3>
        </div><!-- card-body -->
      </div><!-- card -->
       
    </div>
  </div><!-- col-3 -->
  <div class="col-sm-6 col-lg-12 col-xl-3 mg-t-20 mg-xl-t-0">
    <div class="d-lg-flex d-xl-block">
      <div class="card wd-lg-50p wd-xl-auto">
        <div class="card-header">
          <h6 class="card-title tx-14 mg-b-0">Portfolio cost</h6>
        </div><!-- card-header -->
        <div class="card-body">
          <h3 class="tx-bold tx-inverse lh--5 mg-b-15">$15,126,369.20 <span class="tx-base tx-normal tx-gray-600">/ Goal: 8m:0s</span></h3>
        </div><!-- card-body -->
      </div><!-- card -->
       
    </div>
  </div><!-- col-3 -->
  
  
</div>

<hr/>
<button class="nav-link" data-toggle="modal" data-target="#modalTransaction" href>Buy/Sell</button>

  <div class="card bd-0">
    <div class="card-header bg-gray-400 bd-b-0-f pd-b-0">
      <nav class="nav nav-tabs">        
        <a class="nav-link active show" data-toggle="tab" href="#tabContTransactions">Transactions</a>
        <a class="nav-link" data-toggle="tab" href="#tabContStockDetails">Stock Details</a>
        <a class="nav-link" data-toggle="tab" href="#tabContHoldings">Holdings</a>
        <a class="nav-link" data-toggle="tab" href="#tabContProfitLoss">ProfitLoss</a>
        <a class="nav-link" data-toggle="tab" href="#tabContPortfolioValue">Portfolio Value</a>
        <a class="nav-link" data-toggle="tab" href="#tabContNAV">NAV</a>
        <a class="nav-link" data-toggle="tab" href="#tabContSectoralComposition">Sectoral Composition</a>
      </nav>
    </div><!-- card-header -->
    <div class="card-body bd bd-t-0 tab-content">
      <div id="tabContTransactions" class="tab-pane active show">
        <div>
          <div class="table-responsive">
            <div class="dataTables_wrapper no-footer" >
              <table id="transaction_table" class="table table-striped table-hover nowrap dt-responsive">
                <thead>
                  <tr>
                    <th>symbol</th>
                    <th>purchase date</th>                  
                    <th>name</th>
                    <th>transaction type</th>                  
                    <th>quantity</th>
                    <th>purchase cost</th>
                    <th>commissions</th>
                    <th>fees</th>
                    <th>net value</th>
                  </tr>
                </thead>
                <tbody>
                  
                  {% for transaction in transactions %}
                    <tr>
                      {% for s in stock %}
                        {% if transaction.symbol in s.symbol %}
                          <td>{{ transaction.symbol }}</td>  
                          <td>{{ transaction.purchase_date }}</td>                        
                          <td>{{ s.longName }}</td>  
                          {% if 'BUY' in transaction.transaction_type %}
                            <td><label class="badge badge-success">{{ transaction.transaction_type }}</label></td>
                          {% endif %}    
                          {% if 'SELL' in transaction.transaction_type %}
                            <td><label class="badge badge-danger">{{ transaction.transaction_type }}</label></td>
                          {% endif %}  
                          <td>{{ transaction.quantity }}</td>
                          <td>{{ transaction.purchase_cost }}</td>
                          <td>{{ transaction.commissions }}</td>
                          <td>{{ transaction.fees }}</td>
                          <td>{{ 12 }}</td>                        
                        {% endif %}      
                      {% endfor %}
                      
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="row m-3">
            <div class="col">
              <div class="container-fluid">        
                <div id="container" class="chart"></div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- tab-pane -->
      <div id="tabContHoldings" class="tab-pane">
        <div>
          <div class="table-responsive">
            <div class="dataTables_wrapper no-footer">
              <table id="holding_table" class="table table-striped table-hover wrap dt-responsive">
                <thead>
                  <tr>
                    <th>symbol</th>
                    <th>name</th>
                    <th>quantity</th>
                    <th>regularMarketPrice</th>
                    <th>Day Change</th>
                    <th>Day Change %</th>
                    <th>Day Lo</th>
                    <th>Day Hi</th>
                    <th>52 Week Lo</th>
                    <th>52 Week Hi</th>
                    <th>Volume</th>
                    <th>Volume Average 10 days</th>
                    <th>Volume Average 3M</th>
                    <th>MktCap</th>
                    <th>EPS</th>
                    <th>P/E</th>
                    <th>P/B</th>
                    <th>EV/EBITDA</th>
                    <th>Dividend Yield</th>
                    <th>D/E</th>
                    <th>ROE</th>
                    <th>ROA</th>
                    <th>Revenues</th>
                    <th>EBITDA</th>
                    <th>Sector</th>
                    <th>Industry</th>
                    <th>Website</th>
                  </tr>
                </thead> 
                <tbody>                                  
                  {% for portfolioStock in portfolio.stocks %}
                    {% for s in stock %}
                      {% if portfolioStock.symbol in s.symbol %}
                        <tr>
                        <td>{{ s.symbol }}</td>    
                        <td>{{ s.longName }}</td>                    
                        <td>{{ portfolioStock.quantity }}</td>
                        <td>{{ s.regularMarketPrice }}</td>
                        <td>{{ s.regularMarketChange }}</td>
                        <td>{{ s.regularMarketChangePercent }}</td>
                        <td>{{ s.regularMarketDayLow }}</td>
                        <td>{{ s.regularMarketDayHigh }}</td>
                        <td>{{ s.fiftyTwoWeekLow }}</td>
                        <td>{{ s.fiftyTwoWeekHigh }}</td>
                        <td>{{ s.regularMarketVolume }}</td>
                        <td>{{ s.averageDailyVolume10Day }}</td>
                        <td>{{ s.averageDailyVolume3Month }}</td>
                        <td>{{ s.marketCap }}</td>
                        <td>{{ s.epsTrailingTwelveMonths }}</td>
                        <td>{{ s.trailingPE }}</td>
                        <td>{{ s.priceToBook }}</td>
                        <td>{{ s.enterpriseToEbitda }}</td>
                        <td>{{ s.trailingAnnualDividendYield }}</td>
                        <td>{{ s.debtToEquity }}</td>
                        <td>{{ s.returnOnEquity }}</td>
                        <td>{{ s.returnOnAssets }}</td>
                        <td>{{ s.totalRevenue }}</td>
                        <td>{{ s.ebitda }}</td>
                        <td>{{ s.sector }}</td>
                        <td>{{ s.industry }}</td>
                        <td>{{ s.website }}</td>
                      </tr>
                      {% endif %}
                    {% endfor %}
                  {% endfor %}                  
                </tbody>               
              </table>
            </div>
          </div>
          
            <figure class="highcharts-figure">
              <div id="container-NOS"></div>
              <p class="highcharts-description">
                  Chart showing use of rotated axis labels and data labels. This can be a
                  way to include more labels in the chart, but note that more labels can
                  sometimes make charts harder to read.
              </p>
          </figure>
          
        </div>
      </div><!-- tab-pane -->
      <div id="tabContProfitLoss" class="tab-pane">
        <div class="container-fluid">
          <div class="table-responsive">
            <div class="dataTables_wrapper no-footer" >
              <table id="ProfitLoss_table" class="table table-striped table-hover nowrap dt-responsive">
                <thead>
                  <tr>
                    <th>symbol</th>
                    <th>purchase date</th>                  
                    <th>name</th>
                    <th>quantity</th>
                    <th>purchase cost</th>
                    <th>selling cost</th>
                    <th>net profit</th>
                    <th>net profit %</th>
                    <th>days held</th>
                  </tr>
                </thead>
                <tbody>
                  
                  {% for transaction in transactions %}
                    <tr>
                      {% for s in stock %}
                        {% if transaction.symbol in s.symbol %}
                          <td>{{ transaction.symbol }}</td>  
                          <td>{{ transaction.purchase_date }}</td>                        
                          <td>{{ s.longName }}</td>                             
                          <td>{{ transaction.quantity }}</td>
                          <td>{{ transaction.purchase_cost }}</td>
                          <td>{{ transaction.purchase_cost }}</td>
                          <td>10</td>
                          <td>11</td>
                          <td>12</td>                        
                        {% endif %}      
                      {% endfor %}
                      
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          
        </div>
      </div><!-- tab-pane -->
      <div id="tabContPortfolioValue" class="tab-pane">

      </div><!-- tab-pane -->
      <div id="tabContNAV" class="tab-pane">

      </div><!-- tab-pane -->
      <div id="tabContStockDetails" class="tab-pane">
        <div>
          <div class="table-responsive">
            <div class="dataTables_wrapper no-footer">
              <table id="stockdetail_table" class="table table-striped table-hover wrap dt-responsive">
                <thead>
                  <tr>
                    <th>symbol</th>
                    <th>name</th>
                    <th>quantity</th>
                    <th>regularMarketPrice</th>
                    <th>Day Change</th>
                    <th>Day Change %</th>
                    <th>Day Lo</th>
                    <th>Day Hi</th>
                    <th>52 Week Lo</th>
                    <th>52 Week Hi</th>
                    <th>Volume</th>
                    <th>Volume Average 10 days</th>
                    <th>Volume Average 3M</th>
                    <th>MktCap</th>
                    <th>EPS</th>
                    <th>P/E</th>
                    <th>P/B</th>
                    <th>EV/EBITDA</th>
                    <th>Dividend Yield</th>
                    <th>D/E</th>
                    <th>ROE</th>
                    <th>ROA</th>
                    <th>Revenues</th>
                    <th>EBITDA</th>
                    <th>Sector</th>
                    <th>Industry</th>
                    <th>Website</th>
                  </tr>
                </thead> 
                <tbody>                                  
                  {% for portfolioStock in portfolio.stocks %}
                    {% for s in stock %}
                      {% if portfolioStock.symbol in s.symbol %}
                        <tr>
                        <td>{{ s.symbol }}</td>    
                        <td>{{ s.longName }}</td>                    
                        <td>{{ portfolioStock.quantity }}</td>
                        <td>{{ s.regularMarketPrice }}</td>
                        <td>{{ s.regularMarketChange }}</td>
                        <td>{{ s.regularMarketChangePercent }}</td>
                        <td>{{ s.regularMarketDayLow }}</td>
                        <td>{{ s.regularMarketDayHigh }}</td>
                        <td>{{ s.fiftyTwoWeekLow }}</td>
                        <td>{{ s.fiftyTwoWeekHigh }}</td>
                        <td>{{ s.regularMarketVolume }}</td>
                        <td>{{ s.averageDailyVolume10Day }}</td>
                        <td>{{ s.averageDailyVolume3Month }}</td>
                        <td>{{ s.marketCap }}</td>
                        <td>{{ s.epsTrailingTwelveMonths }}</td>
                        <td>{{ s.trailingPE }}</td>
                        <td>{{ s.priceToBook }}</td>
                        <td>{{ s.enterpriseToEbitda }}</td>
                        <td>{{ s.trailingAnnualDividendYield }}</td>
                        <td>{{ s.debtToEquity }}</td>
                        <td>{{ s.returnOnEquity }}</td>
                        <td>{{ s.returnOnAssets }}</td>
                        <td>{{ s.totalRevenue }}</td>
                        <td>{{ s.ebitda }}</td>
                        <td>{{ s.sector }}</td>
                        <td>{{ s.industry }}</td>
                        <td>{{ s.website }}</td>
                      </tr>
                      {% endif %}
                    {% endfor %}
                  {% endfor %}                  
                </tbody>               
              </table>
            </div>
          </div>
        </div>
      </div><!-- tab-pane -->
      <div id="tabContSectoralComposition" class="tab-pane">
        <figure class="highcharts-figure">
          <div id="container-sector"></div>
          <p class="highcharts-description">
              This pie chart shows how the chart legend can be used to provide
              information about the individual slices.
          </p>
      </figure>
      </div><!-- tab-pane -->
    </div><!-- card-body -->
  </div>

  <div class="container-fluid">
    
    <div class="modal" id="modalTransaction">
      <div class="modal-dialog"  role="document">
        <div class="modal-content" id="modalForm">
          <div class="modal-header">
            <h6 class="modal-title">Buy Stock</h6>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">Ã—</span>
            </button>
          </div>
            <form id="myTransactionForm">
              <div class="modal-body">
                 <!-- <h6>Let's get you all setup so you can begin tracking your investments.</h6> -->
                <!-- <p>Some Random Text.Someme Random Text.Some Random Text.Some RRandom Text.Some Random Text. </p> -->

                {% crispy form %}
                <!-- {{ form|crispy }} -->
              </div>
              <!-- <div class="modal-footer">
                <input type="submit" id="submit-id-submit" class="btn btn-indigo">
              </div> -->
            </form>
        </div><!-- modal-content -->
      </div><!-- modal-dialog -->
    </div><!-- modal -->    
  </div>

  <br/>
  
  
  

  <hr/>

  <!-- <h3>Transactions</h3>
  <div class="row m-3">
    <div class="col">
      <div class="container-fluid">
        <div class="table-responsive">
          <div class="dataTables_wrapper no-footer" style="width:90%;">
            <table id="transaction_table" class="table table-striped table-hover nowrap dt-responsive">
              <thead>
                <tr>
                  <th>symbol</th>
                  <th>name</th>
                  <th>quantity</th>
                  <th>adjusted buy price</th>
                  <th>regularMarketPrice</th>
                  <th>current value</th>
                  <th>profit</th>
                  <th>profit %</th>
                  <th>portfolio %</th>

                  <th>purchase date</th>
                  
                  
                  <th>purchase cost</th>
                  <th>commissions</th>
                  <th>fees</th>
                  <th>update cash balance</th>
                  <th>transaction type</th>
                  <th>days_held</th>
                  <th>current_value</th>
                  <th>Day Change</th>
                  <th>Day Change %</th>
                  <th>Day Lo</th>
                  <th>Day Hi</th>
                  <th>52 Week Lo</th>
                  <th>52 Week Hi</th>
                  <th>Volume</th>
                  <th>Volume Average 10 days</th>
                  <th>Volume Average 3M</th>
                  <th>MktCap</th>
                  <th>EPS</th>
                  <th>P/E</th>
                  <th>P/B</th>
                  <th>EV/EBITDA</th>
                  <th>Dividend Yield</th>
                  <th>D/E</th>
                  <th>ROE</th>
                  <th>ROA</th>
                  <th>Revenues</th>
                  <th>EBITDA</th>
                  <th>Sector</th>
                  <th>Industry</th>
                  <th>Website</th>
                  <th>created</th>
                  <th>modified</th>
                </tr>
              </thead>
              <tbody>
                
                {% for transaction in transactions %}
                  <tr>
                    {% for s in stock %}
                      {% if transaction.symbol in s.symbol %}
                      
                        <td>{{ transaction.symbol }}</td>  
                        <td>{{ s.longName }}</td>  
                        <td>{{ transaction.quantity }}</td>
                        <td>{{ transaction.adjusted_buy_price }}</td>                    
                        <td>{{ transaction.regularMarketPrice }}</td>

                        <td>{{ transaction.current_value }}</td>
                        <td>{{ transaction.profit }}</td>
                        <td>{{ transaction.profit_percentage }}</td>
                        <td>{{ transaction.portfolio_percentage }}</td>

                        <td>{{ transaction.purchase_date }}</td>
                        <td>{{ transaction.purchase_cost }}</td>
                        <td>{{ transaction.commissions }}</td>
                        <td>{{ transaction.fees }}</td>
                        <td>{{ transaction.update_cash_balance }}</td>
                        <td>{{ transaction.transaction_type }}</td>

                        <td>{{ s.days_held }}</td>
                        <td>{{ s.current_value }}</td>
                        <td>{{ s.regularMarketChange }}</td>
                        <td>{{ s.regularMarketChangePercent }}</td>
                        <td>{{ s.regularMarketDayLow }}</td>
                        <td>{{ s.regularMarketDayHigh }}</td>
                        <td>{{ s.fiftyTwoWeekLow }}</td>
                        <td>{{ s.fiftyTwoWeekHigh }}</td>
                        <td>{{ s.regularMarketVolume }}</td>
                        <td>{{ s.averageDailyVolume10Day }}</td>
                        <td>{{ s.averageDailyVolume3Month }}</td>
                        <td>{{ s.marketCap }}</td>
                        <td>{{ s.epsTrailingTwelveMonths }}</td>
                        <td>{{ s.trailingPE }}</td>
                        <td>{{ s.priceToBook }}</td>
                        <td>{{ s.enterpriseToEbitda }}</td>
                        <td>{{ s.trailingAnnualDividendYield }}</td>
                        <td>{{ s.debtToEquity }}</td>
                        <td>{{ s.returnOnEquity }}</td>
                        <td>{{ s.returnOnAssets }}</td>
                        <td>{{ s.totalRevenue }}</td>
                        <td>{{ s.ebitda }}</td>
                        <td>{{ s.sector }}</td>
                        <td>{{ s.industry }}</td>
                        <td>{{ s.website }}</td>
                        <td>{{ transaction.created }}</td>
                        <td>{{ transaction.modified }}</td>  
                      {% endif %}      
                    {% endfor %}
                    
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div> -->
  
  
  

  <!-- {{ stock }} -->
  <!-- <input id="datetimepicker" type="text"> -->

  <!-- <div id="events">
      Event summary - new events added at the top
  </div> -->

  



{% endblock %}  


{% block javascript %}
  <script src="//cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.rawgit.com/xcash/bootstrap-autocomplete/3de7ad37/dist/latest/bootstrap-autocomplete.js"></script>


  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/data.js"></script>
  
  <script src="https://code.highcharts.com/stock/indicators/indicators-all.js"></script>
  <script src="https://code.highcharts.com/stock/modules/drag-panes.js"></script>
  
  <script src="https://code.highcharts.com/modules/annotations-advanced.js"></script>
  <script src="https://code.highcharts.com/modules/price-indicator.js"></script>
  <script src="https://code.highcharts.com/modules/full-screen.js"></script>
  
  <script src="https://code.highcharts.com/modules/stock-tools.js"></script>

  <script> //autoComplete
    // var symbol = document.getElementById('id_symbol').textContent
    $('#id_symbol').autoComplete({
        resolverSettings: {
            url: window.location.origin + '/api/suggestions/'
        }
                
    });
 
    
    $('#id_symbol').on('autocomplete.select', function (e) {
          // var symbol = $('#id_symbol').val()
          var symbol = document.getElementById('id_symbol').value

					console.log(symbol);
          $.ajax({
            type: "GET",
            url: window.location.origin + '/api/price/',
            data: { 'q' :  symbol},
            success: function(response) {
              // show response for success
              // console.log(response)
              document.getElementById('id_regularMarketPrice').value = response
            },
            error:function(e) {
              // show response for success
              console.log(e)
            },
          });
				});
    


  </script>


  <script> //transaction_table and charts

    $(document).ready(function() {

      
      var events = $('#events');
      var portfolio_id = document.getElementById('portfolio_id').textContent
      var collapsedGroups = {};

      var table = $('#transaction_table').DataTable({
        bAutoWidth: false,
        responsive: true,
        colReorder: true,
        stateSave:  false,
        paging: true,
        autoWidth: true,
        select: {
            style: 'single'
        },
        columnDefs: [
          {"className": "dt-center", 
          "targets": "_all"}
        ],
        order: [[ 0, "desc" ]],

        rowGroup: {
          dataSrc: 0,
          startRender: function ( rows, group ) {
            var collapsed = !!collapsedGroups[group];

            rows.nodes().each(function (r) {
              r.style.display = collapsed ? 'none' : '';
            });

            return $('<tr/>')
              .append('<td colspan="9" align="left">' + group + ' (' + rows.count() + ')</td>')
              .attr('data-name', group)
              .toggleClass('collapsed', collapsed);
          },
        },
        
      })

      var chart_symbol = 'SYMBOL'

      $('#transaction_table tbody tr.group-start').each(function() {
                var name = $(this).data('name');
                collapsedGroups[name] = !collapsedGroups[name];
      });
      table.draw(false);

      $('#transaction_table tbody').on('click', 'tr.group-start', function () {
                var name = $(this).data('name');
                chart_symbol = name
                collapsedGroups[name] = !collapsedGroups[name];                
                table.draw(false);
      }); 
      
      
      
      table
        .on( 'select', function ( e, dt, type, indexes ) {
            var rowData = table.rows( indexes ).data().toArray();
            // console.log('selected transactio table', rowData)
            var name = rowData[0][0];
            chart_symbol = name
            console.log(chart_symbol)
            // events.prepend( '<div><b>'+type+' selection</b> - '+JSON.stringify( rowData )+'</div>' );

            if (chart_symbol.includes('.')) {
              chart_new_symbol = chart_symbol.replace('.', 'DOT')
            }
            else{
              chart_new_symbol = chart_symbol
            }

            Highcharts.getJSON(window.location.origin + '/api/charts/' + chart_new_symbol + 'delimeter10y/', function (data) {

              // console.log('Highcharts', data)

              // split the data set into ohlc and volume
              var ohlc = [],
              volume = [],
              dataLength = data.length,
              i = 0;

              for (i; i < dataLength; i += 1) {
                ohlc.push([
                  data[i][0], // the date
                  data[i][1], // open
                  data[i][2], // high
                  data[i][3], // low
                  data[i][4] // close
                ]);

                volume.push([
                  data[i][0], // the date
                  data[i][5] // the volume
                ]);
              }

              Highcharts.stockChart('container', {
              yAxis: [{
                labels: {
                  align: 'left'
                },
                height: '80%',
                resize: {
                  enabled: true
                }
              }, {
                labels: {
                  align: 'left'
                },
                top: '80%',
                height: '20%',
                offset: 0
              }],
              tooltip: {
                shape: 'square',
                headerShape: 'callout',
                borderWidth: 0,
                shadow: false,
                positioner: function (width, height, point) {
                  var chart = this.chart,
                    position;

                  if (point.isHeader) {
                    position = {
                      x: Math.max(
                        // Left side limit
                        chart.plotLeft,
                        Math.min(
                          point.plotX + chart.plotLeft - width / 2,
                          // Right side limit
                          chart.chartWidth - width - chart.marginRight
                        )
                      ),
                      y: point.plotY
                    };
                  } else {
                    position = {
                      x: point.series.chart.plotLeft,
                      y: point.series.yAxis.top - chart.plotTop
                    };
                  }

                  return position;
                }
              },
              title: {
                  text: chart_symbol + ' Stock Price'
              },
              series: [{
                type: 'ohlc',
                id: 'ohlc',
                name: chart_symbol + ' Stock Price',
                data: ohlc
              }, {
                type: 'column',
                id: 'volume',
                name: chart_symbol + ' Volume',
                data: volume,
                yAxis: 1
              }],
              responsive: {
                rules: [{
                  condition: {
                    maxWidth: 800
                  },
                  chartOptions: {
                    rangeSelector: {
                      inputEnabled: false
                    }
                  }
                }]
              }
              });
            });
        } )
        .on( 'deselect', function ( e, dt, type, indexes ) {
            var rowData = table.rows( indexes ).data().toArray();
            events.prepend( '<div><b>'+type+' <i>de</i>selection</b> - '+JSON.stringify( rowData )+'</div>' );
        } );


        // const tr = $("<tr><td>CASH</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>");
        // table.row.add(tr[0]).draw();



      
        
      





    });



  </script>


  <script>//default_commission
    $(function () {
      var portfolio_default_commission = document.getElementById('portfolio_default_commission').textContent
      document.getElementById('id_commissions').value =  portfolio_default_commission
    });
    
  </script>
  

  <script> //updateTransactions

    updateTransactions()

    //Making a GET request with fetch
    function updateTransactions() {

      console.log('Updating Trasnactions ...')

      // var listTransactionWrapper = document.getElementById('list-transaction')
      // listTransactionWrapper.innerHTML = ''

      var portfolio_id = document.getElementById('portfolio_id').textContent
      var URL = window.location.origin + '/api/portfolios/' + portfolio_id + '/transactions/'

      fetch(URL, {
        headers:{
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest', //Necessary to work with request.is_ajax()
        },
      })
      .then(response => {
      
        return response.json() //Convert response to JSON      
      })
      .then(data => {
        //Perform actions with the response data from the view      
        // console.log('GET Transaction List - : ', data.results)
        $('#example').DataTable().draw()
        

        var list = data.results
        for (var i in list) {
          // console.log('GET Transaction Data: ', list[i])
          
        }
        
      })
    }

  //Making a POST/Update request with fetch
  const transactionForm = document.getElementById('myTransactionForm')
    
  transactionForm.addEventListener('submit', function(e){
    e.preventDefault();

    console.log('Submitting Transaction - POST')

    var portfolio_id = document.getElementById('portfolio_id').textContent
    var URL = window.location.origin + '/api/portfolios/' + portfolio_id + '/transactions/'

    const data = new FormData(this)
    const searchParam = new URLSearchParams()
    
    for (const pair of data) {
      searchParam.append(pair[0], pair[1])
      console.log(pair[0], pair[1])
    }

    fetch(URL, {
      method: 'POST',
      headers:{
          'Accept': 'application/json',
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest', //Necessary to work with request.is_ajax()
          'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify({
        'symbol': searchParam.get('symbol'),
        'commissions': searchParam.get('commissions'),
        'fees': searchParam.get('fees'),
        'comments': searchParam.get('comments'),
        'transaction_type': searchParam.get('transaction_type'),
        'regularMarketPrice': searchParam.get('regularMarketPrice'),
        'quantity': searchParam.get('quantity'),
        'portfolio': portfolio_id,
        'update_cash_balance': searchParam.get('update_cash_balance'),
      }) //JavaScript object of data to POST
    })

    .then(response => {
      updateTransactions()
      document.getElementById('myTransactionForm').reset()
      $('#modalTransaction').modal('toggle');
    })
    .then(data => {
      console.log('POSTED Transaction DATA', data)      
      $('#example').DataTable().draw()
      //Perform actions with the response data from the view
    })
    .catch(error => {
      console.log('ERROR', error)
    })
    
  });



  </script>

<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/export-data.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

  <script>// Build the sectoral chart
    
    Highcharts.chart('container-sector', {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false,
            type: 'pie'
        },
        title: {
            text: 'Portfolio Sectoral Composition'
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
        },
        accessibility: {
            point: {
                valueSuffix: '%'
            }
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: false
                },
                showInLegend: true
            }
        },
        series: [{
            name: 'Brands',
            colorByPoint: true,
            data: [{
                name: 'Chrome',
                y: 61.41,
                sliced: true,
                selected: true
            }, {
                name: 'Internet Explorer',
                y: 11.84
            }, {
                name: 'Firefox',
                y: 10.85
            }, {
                name: 'Edge',
                y: 4.67
            }, {
                name: 'Safari',
                y: 4.18
            }, {
                name: 'Other',
                y: 7.05
            }]
        }]
    });
  </script>

<script>//build no of stock chart
  var portfolio_id = document.getElementById('portfolio_id').textContent
  Highcharts.getJSON(window.location.origin + '/api/portfolios/' + portfolio_id + '/stocks/', function (data) {

    // console.log('Highcharts', data)

    // split the data set into ohlc and volume
    var ohlc = [],
    dataLength = data.results.length
    // console.log('dataLength', dataLength)
    i = 0;

    for (i; i < dataLength; i += 1) {
      // console.log('data', data.results[i]['symbol'])
      ohlc.push([        
        data.results[i]['symbol'], // symbol
        data.results[i]['quantity'], // qty
      ]);
    }

    // console.log('Data', ohlc)
  
    Highcharts.chart('container-NOS', {
        chart: {
            type: 'column'
        },
        title: {
            text: 'Stock\'s holding in Portfolio'
        },
        subtitle: {
            text: 'Subtitle'
        },
        xAxis: {
            type: 'category',
            labels: {
                rotation: -45,
                style: {
                    fontSize: '13px',
                    fontFamily: 'Verdana, sans-serif'
                }
            }
        },
        yAxis: {
            min: 0,
            title: {
                text: 'Holdings (in numbers)'
            }
        },
        legend: {
            enabled: false
        },
        tooltip: {
            pointFormat: 'Holdings: <b>{point.y:.1f}</b>'
        },
        series: [{
            name: 'Holdings',

            data: ohlc,

            dataLabels: {
                enabled: true,
                rotation: -90,
                color: '#FFFFFF',
                align: 'right',
                format: '{point.y:.1f}', // one decimal
                y: 10, // 10 pixels down from the top
                style: {
                    fontSize: '13px',
                    fontFamily: 'Verdana, sans-serif'
                }
            }
        }]
    });
  });
</script>

<script>
  /* Formatting function for row details - modify as you need */
function format ( d ) {
    // `d` is the original data object for the row
    console.log(d[0])
    var transactions = JSON.parse('{{ transaction_js | safe }}')

    var stock = JSON.parse('{{ stock_js | safe }}')
    
    staticTemplate = '<h6>Transactions</h6>' +
          '<div class="table-responsive">' +
            '<div class="dataTables_wrapper no-footer" >' +
              '<table id="transactions_table" class="table table-striped table-hover nowrap dt-responsive">' +
                '<thead>' +
                  '<tr>' + 
                    '<th>symbol</th><th>purchase date</th><th>name</th>' +
                    '<th>transaction type</th><th>quantity</th>' +
                    '<th>purchase cost</th><th>commissions</th>' +
                    '<th>fees</th><th>net value</th>' +
                  '</tr>' +
                '</thead>' +
                '<tbody>' 
    
    dynamicTemplate = ''

    transactions.forEach(transaction => {
      // console.log(transaction['fields']['symbol'])
      dynamicTemplate += '<tr>' 
        // console.log(s['fields']['symbol'])
        if (transaction['fields']['symbol'] == d[0]) {
          dynamicTemplate += '<td>' +  transaction['fields']['symbol']  + '</td>'  
          dynamicTemplate += '<td>' +  transaction['fields']['purchase_date'] + '</td>'                        
          dynamicTemplate += '<td><label class="badge badge-success">' + transaction['fields']['transaction_type'] + '</label></td>' 
          dynamicTemplate += '<td>' +  transaction['fields']['quantity'] + '</td>'  
          dynamicTemplate += '<td>' +  transaction['fields']['purchase_cost'] + '</td>'  
          dynamicTemplate += '<td>' +  transaction['fields']['commissions'] + '</td>'  
          dynamicTemplate += '<td>' +  transaction['fields']['fees'] + '</td>'  
          dynamicTemplate += '<td>' +  12 + '</td>'  
          dynamicTemplate += '<td>' +  12 + '</td>'  
        }
      dynamicTemplate += '</tr>' 
    });

    return staticTemplate + dynamicTemplate +
                '</tbody>' +
              '</table>' + 
            '</div>' +
          '</div>';
}

  var collapsedGroups = {};
  var tableS = $('#stockdetail_table').DataTable({
        bAutoWidth: false,
        responsive: true,
        colReorder: true,
        stateSave:  false,
        paging: true,
        autoWidth: true,
        select: {
            style: 'single'
        },
        columnDefs: [
          {"className": "dt-center", 
          "targets": "_all"}
        ],
        order: [[ 0, "desc" ]],

        rowGroup: {
          dataSrc: 0,
          startRender: function ( rows, group ) {
            var collapsed = !!collapsedGroups[group];

            rows.nodes().each(function (r) {
              r.style.display = collapsed ? 'none' : '';
            });

            return $('<tr/>')
              .append('<td colspan="27" align="left">' + group + ' (' + rows.count() + ')</td>')
              .attr('data-name', group)
              .toggleClass('collapsed', collapsed);
          },
        },
        
      })

      $('#stockdetail_table tbody tr.group-start').each(function() {
                var name = $(this).data('name');
                collapsedGroups[name] = !collapsedGroups[name];
      });
      tableS.draw(false);

      $('#stockdetail_table tbody').on('click', 'tr.group-start', function () {
                var name = $(this).data('name');
                chart_symbol = name
                collapsedGroups[name] = !collapsedGroups[name];     

                tableS.draw(false);
      }); 

      // Add event listener for opening and closing details
      $('#stockdetail_table tbody').on('click', 'td.dt-center', function () {
          var tr = $(this).closest('tr');
          var row = tableS.row( tr );
          if ( row.child.isShown() ) {
              // This row is already open - close it
              row.child.hide();
              tr.removeClass('shown');
          }
          else {
              // Open this row
              row.child( format(row.data()) ).show();
              tr.addClass('shown');
          }
      } );
  
</script>

{% endblock %}
